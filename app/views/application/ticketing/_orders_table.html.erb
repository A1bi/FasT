<% cache_if local_assigns[:cache_key].present?, [local_assigns[:cache_key], orders, params[:type]] do %>
  <%
    additional_columns ||= []
    number_of_columns = 4 + additional_columns.count
  %>
  <table class="rounded entries details <%= local_assigns.fetch(:class, nil) %>">
    <thead>
      <% if defined? table_title %>
        <% Array(table_title).each do |title| %>
          <tr>
            <th colspan="<%= number_of_columns %>"><%= title %></th>
          </tr>
        <% end %>
      <% end %>
      <% if orders.any? %>
        <tr>
          <% if :checkbox.in?(additional_columns) %>
            <th></th>
          <% end %>
          <th>Nummer</th>
          <th><% if local_assigns[:web] %>Name<% else %>Vorverkaufsstelle<% end %></th>
          <th>Artikel</th>
          <% if :date.in?(additional_columns) %>
            <th>Termin</th>
          <% end %>
          <% if :balance.in?(additional_columns) %>
            <th>offen</th>
          <% end %>
          <th>Datum</th>
        </tr>
      <% end %>
    </thead>
    <tbody class="hover">
      <% orders.each do |order| %>
        <% classes = :cancelled if order.cancelled? %>
        <%= content_tag :tr, class: classes, data: { controller: 'linked-row', 'linked-row-path': ticketing_order_path(order) } do %>
          <% if :checkbox.in?(additional_columns) %>
            <td class="checkbox"><%= check_box_tag "orders[]", order.id %></td>
          <% end %>
          <td class="number"><%= link_to order.number, ticketing_order_path(order) %></td>
          <td class="name">
            <% if local_assigns[:web] %>
              <%= name_and_affiliation(sorted_name(order), order.affiliation, 'nicht angegeben') %>
            <% elsif order.is_a? Ticketing::Retail::Order %>
              <%= order.store.name %>
            <% end %>
          </td>
          <td class="tickets"><%= order.items.size %></td>
          <% if :date.in?(additional_columns) %>
            <td>
              <% if order.date.present? %>
                <%= l order.date.date, format: '%-d. %B' %><br>
                <%= content_tag :span, truncate(order.event.name, length: 12), title: order.event.name, class: :small %>
              <% end %>
            </td>
          <% end %>
          <% if :balance.in?(additional_columns) %>
            <td class="amount"><%= number_to_currency(-order.balance) %></td>
          <% end %>
          <td class="date"><%= l order.created_at, format: "%d.%m.%y, %H:%M" %></td>
        <% end %>
      <% end %>
      <% if orders.empty? %>
        <tr>
          <td colspan="5" class="empty">Keine Bestellungen vorhanden.</td>
        </tr>
      <% end %>
    </tbody>
  </table>
<% end %>
