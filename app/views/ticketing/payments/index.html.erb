<% title "Zahlungsverwaltung" %>
<% include_css "ticketing/orders" %>
<% include_js "ticketing/orders" %>
<div class="hl">Zahlungsverwaltung</div>
<% cache [:ticketing, :payments, @unsubmitted_charges, @submissions] do %>
  <table class="rounded entries details">
    <thead>
      <tr>
        <th colspan="3">Einzureichende Lastschriften</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <% if @unsubmitted_charges.any? %>
          <td colspan="2"><%= @unsubmitted_charges.count %> Lastschriften einzureichen.</td>
          <td><em>Einreichen derzeit noch nicht möglich.</em></td>
        <% else %>
          <td colspan="3" class="empty">Keine Lastschriften einzureichen.</td>
        <% end %>
      </tr>
    </tbody>
    <thead>
      <tr>
        <th colspan="3">Vergangene Einreichungen</th>
      </tr>
    </thead>
    <tbody>
      <% @submissions.each do |submission| %>
        <tr>
          <td><%= submission.charges.count %> Lastschriften</td>
          <td><%= link_to "Begleitzettel", ticketing_payments_sheet_path(submission) %></td>
          <td class="date"><%= l submission.created_at, format: "%d.%m.%y, %H:%M" %></td>
        </tr>
      <% end %>
    </tbody>
  </table>
<% end %>
<% cache [:ticketing, :payments, :unapproved, @orders[:unapproved]] do %>
  <%= form_tag ticketing_payments_approve_path, method: :patch do %>
    <table class="rounded entries details">
      <thead>
        <tr>
          <th colspan="7">Ungeprüfte Lastschriften</th>
        </tr>
        <% if @orders[:unapproved].any? %>
          <tr>
            <th class="checkbox"><%= check_box_tag "orders_all" %></th>
            <th>Bestellung</th>
            <th>Kontoinhaber</th>
            <th>IBAN</th>
            <th>BIC</th>
            <th>Betrag</th>
          </tr>
        <% end %>
      </thead>
      <tbody class="hover">
        <% @orders[:unapproved].each do |order| %>
          <% charge = order.bank_charge %>
          <tr data-path="<%= ticketing_order_path(order) %>">
            <td class="checkbox"><%= check_box_tag "orders[]", order.id %></td>
            <td class="number"><%= link_to order.number, ticketing_order_path(order) %></td>
            <td class="name"><%= charge.name %></td>
            <td><%= obfuscated_iban(charge.iban) %></td>
            <td><%= charge.bic %></td>
            <td class="amount"><%= number_to_currency order.total %></td>
          </tr>
        <% end %>
        <% if @orders[:unapproved].empty? %>
          <tr>
            <td colspan="5" class="empty">Keine Lastschriften vorhanden.</td>
          </tr>
        <% end %>
      </tbody>
    </table>
    <%= render "index_submit", text: "als geprüft markieren", orders: @orders[:unapproved] %>
  <% end %>
<% end %>
<% cache [:ticketing, :payments, :unpaid, :table, @orders[:unpaid]] do %>
  <%= form_tag ticketing_payments_mark_as_paid_path, method: :patch do %>
    <%= render "application/ticketing/orders_table", table_title: "Unbezahlte Bestellungen", orders: @orders[:unpaid], web: true, checkbox: true, cache_key: [:payments, :unpaid] %>
    <%= render "index_submit", text: "als bezahlt markieren", orders: @orders[:unpaid] %>
  <% end %>
<% end %>